name: Packer Image Build

on:
  repository_dispatch:
    types: [build-image]

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.client_payload.branch }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: 'Load GCP Service Account Key'
        if: github.event.client_payload.platform == 'gcp' && github.event.client_payload.gcp_key_path
        id: gcp_creds
        run: |
          echo "Loading credentials from ${{ github.event.client_payload.gcp_key_path }}"
          CRED_JSON=$(cat "${{ github.event.client_payload.gcp_key_path }}")
          {
            echo 'gcp_credentials_json<<EOF'
            echo "$CRED_JSON"
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        if: github.event.client_payload.platform == 'gcp'
        id: gcp_auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ steps.gcp_creds.outputs.gcp_credentials_json || github.event.client_payload.gcp_credentials_json }}

      - name: '⚙️ Ensure IAP Prerequisites for WinRM'
        if: github.event.client_payload.platform == 'gcp'
        id: setup_iap_prereqs
        run: |
          echo "Setting up IAP Firewall Rule for WinRM..."
          # 1. Create Firewall Rule for IAP Ingress on WinRM HTTPS port (5986)
          gcloud compute firewall-rules create allow-iap-winrm-ingress \
            --project=${{ steps.gcp_auth.outputs.project_id }} \
            --direction=INGRESS \
            --action=ALLOW \
            --rules=tcp:5986 \
            --source-ranges=35.235.240.0/20 \
            --target-tags=packer-windows-build \
            --quiet || echo "Firewall rule 'allow-iap-winrm-ingress' likely already exists."

          echo "Granting IAP Tunnel User Role to the build Service Account..."
          # 2. Get the authenticated Service Account email
          SA_EMAIL=$(gcloud config get-value account)
          echo "Service Account is: $SA_EMAIL"

          # 3. Grant IAP Tunnel User role to the Service Account
          gcloud projects add-iam-policy-binding ${{ steps.gcp_auth.outputs.project_id }} \
            --member="serviceAccount:$SA_EMAIL" \
            --role="roles/iap.tunnelResourceAccessor" || echo "IAM role binding for IAP Tunnel User likely already exists for $SA_EMAIL."

      - name: Configure AWS Credentials for IAM Role
        if: github.event.client_payload.platform == 'aws' && github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.client_payload.aws_role_arn }}
          aws-region: ${{ github.event.client_payload.aws_region || 'us-east-1' }}

      - name: Configure AWS Credentials for Access Keys
        if: github.event.client_payload.platform == 'aws' && !github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.client_payload.aws_region || 'us-east-1' }}
      
      - name: Parse Azure Credentials
        if: github.event.client_payload.platform == 'azure'
        id: parse_azure_creds
        run: |
          creds_json='${{ github.event.client_payload.azure_credentials }}'
          auth_type=$(echo "$creds_json" | jq -r .authType)
          client_id=$(echo "$creds_json" | jq -r .clientId)
          tenant_id=$(echo "$creds_json" | jq -r .tenantId)
          subscription_id=$(echo "$creds_json" | jq -r .subscriptionId)
          echo "auth_type=$auth_type" >> $GITHUB_OUTPUT
          echo "client_id=$client_id" >> $GITHUB_OUTPUT
          echo "tenant_id=$tenant_id" >> $GITHUB_OUTPUT
          echo "subscription_id=$subscription_id" >> $GITHUB_OUTPUT

      - name: Azure Login with OIDC
        if: github.event.client_payload.platform == 'azure' && steps.parse_azure_creds.outputs.auth_type == 'oidc'
        uses: azure/login@v1
        with:
          client-id: ${{ steps.parse_azure_creds.outputs.client_id }}
          tenant-id: ${{ steps.parse_azure_creds.outputs.tenant_id }}
          subscription-id: ${{ steps.parse_azure_creds.outputs.subscription_id }}

      - name: Azure Login with Client Secret
        if: github.event.client_payload.platform == 'azure' && steps.parse_azure_creds.outputs.auth_type != 'oidc'
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ steps.parse_azure_creds.outputs.client_id }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ steps.parse_azure_creds.outputs.subscription_id }}","tenantId":"${{ steps.parse_azure_creds.outputs.tenant_id }}"}'
      
      - name: 'Build Packer Image'
        id: build
        run: |
          export BUILD_ID="${{ github.run_id }}"
          export PLATFORM="${{ github.event.client_payload.platform }}"
          export TEMPLATE_FILE="${{ github.event.client_payload.template_file }}"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Error: Template file $TEMPLATE_FILE not found in the repository's root directory."
            exit 1
          fi

          packer init "$TEMPLATE_FILE"
          
          if [ "$PLATFORM" == "gcp" ]; then
            export PKR_VAR_gcp_project_id="${{ steps.gcp_auth.outputs.project_id }}"
            packer build \
              -var "build_id=$BUILD_ID" \
              -var "platform=$PLATFORM" \
              -var "vm_size=${{ github.event.client_payload.vm_size }}" \
              "$TEMPLATE_FILE"
          elif [ "$PLATFORM" == "azure" ]; then
            packer build \
              -var "build_id=$BUILD_ID" \
              -var "platform=$PLATFORM" \
              -var "vm_size=${{ github.event.client_payload.vm_size }}" \
              -var "managed_image_rg=${{ github.event.client_payload.azure_resource_group }}" \
              "$TEMPLATE_FILE"
          else
            packer build \
              -var "build_id=$BUILD_ID" \
              -var "platform=$PLATFORM" \
              -var "vm_size=${{ github.event.client_payload.vm_size }}" \
              -var "iam_instance_profile=${{ github.event.client_payload.aws_iam_profile }}" \
              "$TEMPLATE_FILE"
          fi
