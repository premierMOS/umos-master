name: Run Patching Job

on:
  workflow_dispatch:
    inputs:
      platform:
        required: true
      instance_ids_json:
        required: true
      # Common
      script_content:
      # AWS specific
      instance_ids:
      ssm_parameters:
      aws_role_arn:
      region:
      # Azure specific
      resource_group:
      azure_credentials:
      # GCP specific
      project_id:
      zone:
      gcp_key_path:
      gcp_credentials_json:

permissions:
  id-token: write
  contents: read

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: 'Debug: Show Webhook Payload'
        run: |
          echo "Platform: ${{ github.event.inputs.platform }}"
          echo "Instance IDs/Names: ${{ github.event.inputs.instance_ids_json }}"

      # --- AWS Steps ---
      - name: Configure AWS Credentials for IAM Role
        if: github.event.inputs.platform == 'aws' && github.event.inputs.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.inputs.aws_role_arn }}
          aws-region: ${{ github.event.inputs.region }}

      - name: Configure AWS Credentials for Access Keys
        if: github.event.inputs.platform == 'aws' && !github.event.inputs.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.region }}

      - name: Send and Poll AWS SSM Command
        if: github.event.inputs.platform == 'aws'
        id: ssm_command
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids ${{ github.event.inputs.instance_ids }} \
            --parameters '${{ github.event.inputs.ssm_parameters }}' \
            --query "Command.CommandId" \
            --output text)
          
          if [ -z "$COMMAND_ID" ]; then
            echo "::error::Failed to send SSM command."
            exit 1
          fi
          
          echo "SSM Command sent with ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Poll SSM Command and Check Status (AWS)
        if: github.event.inputs.platform == 'aws'
        run: |
          INSTANCE_IDS_JSON='${{ github.event.inputs.instance_ids_json }}'
          COMMAND_ID='${{ steps.ssm_command.outputs.command_id }}'
          
          sleep 5
          
          for id in $(echo "$INSTANCE_IDS_JSON" | jq -r '.[]'); do
            echo "Polling SSM command status for instance $id..."
            
            for i in $(seq 1 60); do # Poll for up to 10 minutes
              STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$id" --query "Status" --output text)
              if [[ "$STATUS" == "Success" || "$STATUS" == "Failed" || "$STATUS" == "TimedOut" || "$STATUS" == "Cancelled" ]]; then
                break
              fi
              if [ "$i" -eq 60 ]; then STATUS="TimedOut"; fi
              sleep 10
            done
            
            if [ "$STATUS" != "Success" ]; then
              echo "::error::SSM command failed on instance $id with status: $STATUS"
              exit 1
            fi
            echo "Instance $id patched successfully."
          done
          echo "All AWS instances completed successfully."

      # --- Azure Steps ---
      - name: Parse Azure Credentials
        if: github.event.inputs.platform == 'azure'
        id: parse_azure_creds
        run: |
          creds_json='${{ github.event.inputs.azure_credentials }}'
          auth_type=$(echo "$creds_json" | jq -r .authType)
          client_id=$(echo "$creds_json" | jq -r .clientId)
          tenant_id=$(echo "$creds_json" | jq -r .tenantId)
          subscription_id=$(echo "$creds_json" | jq -r .subscriptionId)
          echo "auth_type=$auth_type" >> $GITHUB_OUTPUT
          echo "client_id=$client_id" >> $GITHUB_OUTPUT
          echo "tenant_id=$tenant_id" >> $GITHUB_OUTPUT
          echo "subscription_id=$subscription_id" >> $GITHUB_OUTPUT

      - name: Azure Login with OIDC
        if: github.event.inputs.platform == 'azure' && steps.parse_azure_creds.outputs.auth_type == 'oidc'
        uses: azure/login@v1
        with:
          client-id: ${{ steps.parse_azure_creds.outputs.client_id }}
          tenant-id: ${{ steps.parse_azure_creds.outputs.tenant_id }}
          subscription-id: ${{ steps.parse_azure_creds.outputs.subscription_id }}

      - name: Azure Login with Client Secret
        if: github.event.inputs.platform == 'azure' && steps.parse_azure_creds.outputs.auth_type != 'oidc'
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ steps.parse_azure_creds.outputs.client_id }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ steps.parse_azure_creds.outputs.subscription_id }}","tenantId":"${{ steps.parse_azure_creds.outputs.tenant_id }}"}'

      - name: Run Azure VM Command for each instance
        if: github.event.inputs.platform == 'azure'
        run: |
          INSTANCE_NAMES_JSON='${{ github.event.inputs.instance_ids_json }}'
          SCRIPT_CONTENT='${{ github.event.inputs.script_content }}'
          RESOURCE_GROUP='${{ github.event.inputs.resource_group }}'

          for name in $(echo "$INSTANCE_NAMES_JSON" | jq -r '.[]'); do
            echo "--- Running command on Azure VM: $name ---"
            
            az vm run-command invoke \
              --resource-group "$RESOURCE_GROUP" \
              --name "$name" \
              --command-id RunShellScript \
              --scripts "$SCRIPT_CONTENT" \
              --output table
              
            if [ $? -ne 0 ]; then
                echo "::error::Run Command failed on instance $name. See output above for details."
                exit 1
            fi
            echo "--- Successfully ran command on $name ---"
          done
          echo "All Azure instances processed."

      # --- GCP Steps ---
      - name: 'Load GCP Service Account Key from file'
        if: github.event.inputs.platform == 'gcp' && github.event.inputs.gcp_key_path
        id: gcp_creds_from_file
        run: |
          echo "Loading credentials from ${{ github.event.inputs.gcp_key_path }}"
          CRED_JSON=$(cat "${{ github.event.inputs.gcp_key_path }}")
          {
            echo 'gcp_credentials_json<<EOF'
            echo "$CRED_JSON"
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        if: github.event.inputs.platform == 'gcp'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ steps.gcp_creds_from_file.outputs.gcp_credentials_json || github.event.inputs.gcp_credentials_json }}

      - name: Run GCP VM Command for each instance
        if: github.event.inputs.platform == 'gcp'
        run: |
          INSTANCE_NAMES_JSON='${{ github.event.inputs.instance_ids_json }}'
          SCRIPT_CONTENT='${{ github.event.inputs.script_content }}'
          PROJECT_ID='${{ github.event.inputs.project_id }}'
          ZONE='${{ github.event.inputs.zone }}'

          # Ensure IAP-secured SSH helper is not used, which can cause interactive prompts
          gcloud config set compute/ssh_helpers false

          for name in $(echo "$INSTANCE_NAMES_JSON" | jq -r '.[]'); do
            echo "--- Running command on GCP VM: $name ---"
            
            # Use --command flag to execute script on the remote instance
            gcloud compute ssh "$name" --project "$PROJECT_ID" --zone "$ZONE" --command "$SCRIPT_CONTENT"
              
            if [ $? -ne 0 ]; then
                echo "::error::Run Command failed on instance $name. See output above for details."
                exit 1
            fi
            echo "--- Successfully ran command on $name ---"
          done
          echo "All GCP instances processed."
