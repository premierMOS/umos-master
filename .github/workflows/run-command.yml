name: Run Ad-Hoc Command

on:
  repository_dispatch:
    types: [run-ad-hoc-command]

jobs:
  run-command:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.client_payload.branch }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: pip install ansible

      - name: Set up SSH key
        id: ssh_key_setup
        env:
          SSH_PRIVATE_KEY: ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "::error::ANSIBLE_SSH_PRIVATE_KEY secret is not set in the repository secrets. This is required for the web shell to connect to instances."
            exit 1
          fi
          KEY_DIR=$(mktemp -d)
          echo "$SSH_PRIVATE_KEY" > "$KEY_DIR/id_rsa"
          chmod 600 "$KEY_DIR/id_rsa"
          ssh-keyscan -H ${{ github.event.client_payload.target_ip }} >> "$KEY_DIR/known_hosts"
          echo "key_path=$KEY_DIR/id_rsa" >> $GITHUB_OUTPUT
          echo "known_hosts_path=$KEY_DIR/known_hosts" >> $GITHUB_OUTPUT

      - name: Run Ansible Command
        id: adhoc
        run: |
          ansible ${{ github.event.client_payload.target_ip }} \
            -i "${{ github.event.client_payload.target_ip }}," \
            -m shell -a "${{ github.event.client_payload.command }}" \
            --user ${{ github.event.client_payload.ssh_user }} \
            --private-key ${{ steps.ssh_key_setup.outputs.key_path }} \
            -e "ansible_ssh_common_args='-o UserKnownHostsFile=${{ steps.ssh_key_setup.outputs.known_hosts_path }}'"
