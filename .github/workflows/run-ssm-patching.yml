name: Run Ansible Patching Job via AWS SSM

on:
  repository_dispatch:
    types: [run-ssm-patching-job]

permissions:
  id-token: write
  contents: read

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: 'Debug: Show Webhook Payload'
        run: |
          echo "Instance IDs: ${{ github.event.client_payload.instance_ids_json }}"
          echo "Playbook Path: ${{ github.event.client_payload.playbook_path }}"

      - name: Configure AWS Credentials for IAM Role
        if: github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.client_payload.aws_role_arn }}
          aws-region: ${{ github.event.client_payload.region }}

      - name: Configure AWS Credentials for Access Keys
        if: "!github.event.client_payload.aws_role_arn"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.client_payload.region }}

      - name: Verify Instances are SSM Managed
        run: |
          INSTANCE_IDS_JSON='${{ github.event.client_payload.instance_ids_json }}'
          for id in $(echo "$INSTANCE_IDS_JSON" | jq -r '.[]'); do
            echo "Checking SSM status for instance: $id"
            INFO=$(aws ssm describe-instance-information --filters "Key=InstanceIds,Values=$id" --query 'InstanceInformationList' --output json)
            if [ "$(echo "$INFO" | jq 'length')" -eq 0 ]; then
              echo "::error::Instance $id is not managed by AWS SSM. This is likely because it is missing the required IAM Instance Profile."
              echo "::error::Please ensure the instance has an IAM profile with the 'AmazonSSMManagedInstanceCore' policy attached. Instances deployed via this app should have this created automatically. Older instances may need to be redeployed."
              exit 1
            fi
            echo "Instance $id is managed by SSM and ready for commands."
          done

      - name: Send SSM Run Command
        id: ssm_command
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids ${{ github.event.client_payload.instance_ids }} \
            --parameters '${{ github.event.client_payload.ssm_parameters }}' \
            --query "Command.CommandId" \
            --output text)
          
          if [ -z "$COMMAND_ID" ]; then
            echo "::error::Failed to send SSM command. This is unexpected as permissions were implicitly checked by the previous step. Please verify the calling role has 'ssm:SendCommand' permissions."
            exit 1
          fi
          
          echo "SSM Command sent with ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Poll SSM Command and Check Status
        run: |
          INSTANCE_IDS_JSON='${{ github.event.client_payload.instance_ids_json }}'
          COMMAND_ID='${{ steps.ssm_command.outputs.command_id }}'
          
          sleep 5 # Brief wait for command to be sent
          
          for id in $(echo "$INSTANCE_IDS_JSON" | jq -r '.[]'); do
            echo "Polling SSM command status for instance $id..."
            
            # Poll for up to 10 minutes (60 attempts * 10 seconds)
            for i in $(seq 1 60); do
              STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$id" --query "Status" --output text)
              
              if [[ "$STATUS" == "Success" || "$STATUS" == "Failed" || "$STATUS" == "TimedOut" || "$STATUS" == "Cancelled" ]]; then
                echo "Command reached terminal state: $STATUS"
                break
              fi
              
              if [ "$i" -eq 60 ]; then
                echo "::error::Polling timed out after 10 minutes. Final status: $STATUS"
                STATUS="TimedOut" # Force status to a failure state
                break
              fi

              echo "Current status: $STATUS. Waiting... (Attempt $i/60)"
              sleep 10
            done
            
            if [ "$STATUS" != "Success" ]; then
              echo "::error::SSM command failed on instance $id with status: $STATUS"
              echo "--- Standard Output ---"
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$id" --query "StandardOutputContent" --output text
              echo "--- Standard Error ---"
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$id" --query "StandardErrorContent" --output text
              echo "------------------------"
              exit 1
            fi
            
            echo "Instance $id patched successfully."
          done
          echo "All instances completed successfully."
